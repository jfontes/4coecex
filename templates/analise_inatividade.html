{% extends 'base.html' %}
{% block title %}Análise de inatividade – Processo {{ proc }}{% endblock %}

{% block extra_head %}
<style>
  /* Estilo para a caixa de texto do modal */
  #modalTextView {
    min-height: 400px;
    font-family: monospace;
    font-size: 0.85rem;
  }
</style>
{% endblock %}

{% block extra_js %}

<script>
(function(){
  const selectGrupo = document.getElementById('selectGrupo');
  const select = document.getElementById('selectCriterio');
  const sugestaoDoc = document.getElementById('sugestaoDocumento');
  const bloco = document.getElementById('blocoAnalise');
  const files = document.getElementById('inputPDFs');
  const btn = document.getElementById('btnAnalisar');
  const btn2 = document.getElementById('btnAdicionar');
  const stat  = document.getElementById('analiseStatus');
  const contexto = document.getElementById('inputContexto');
  const out   = document.getElementById('txtResultado');
  // --- LÓGICA DO POPUP "VER TEXTO" ---
  const btnShowText = document.getElementById('btnShowText');
  const modalTextarea = document.getElementById('modalTextView');

  if (btnShowText) {
    btnShowText.addEventListener('click', function() {
      // Pega o conteúdo HTML do editor e coloca no textarea do popup
      modalTextarea.value = document.getElementById('editor').innerHTML;
    });
  }

// Função para atualizar o dropdown de critérios
  async function atualizarCriterios() {
    const grupoId = selectGrupo.value;
    
    // Limpa o select de critérios
    selectCriterio.innerHTML = '<option value="">Selecione um critério...</option>';
    sugestaoDoc.textContent = 'Sugestão de documento: ';

    if (!grupoId) {
      return; // Se nenhum grupo for selecionado, não faz nada
    }

    try {
      // Faz a chamada à API que criamos
      const url = `/api/grupo/${grupoId}/criterios`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error('Falha ao carregar critérios.');
      }
      const criterios = await response.json();

      // Popula o select com os novos critérios
      criterios.forEach(criterio => {
        const option = document.createElement('option');
        option.value = criterio.id;
        option.textContent = criterio.nome; // O texto da opção continua sendo apenas o nome do critério
        option.dataset.sugestao = criterio.sugestao_documento || '';
        selectCriterio.appendChild(option);
      });

    } catch (error) {
      console.error(error);
    }
  }

  // Adiciona o 'listener' para o evento de mudança no select de Grupo
  selectGrupo.addEventListener('change', atualizarCriterios);

  // Adiciona um listener para o select de Critérios para atualizar a sugestão
  selectCriterio.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    sugestaoDoc.textContent = "Sugestão de documento: " + (selectedOption.dataset.sugestao || "");
  });

  function setStatus(msg, isError=false, showGif=false) {
    stat.textContent = msg || '';
    stat.className = 'small ' + (isError ? 'text-danger' : 'text-muted');
    document.getElementById('loadingGif').style.display = showGif ? 'inline-block' : 'none';
  }

  btn.addEventListener('click', async function(){
    if (!files.files || files.files.length === 0) {
      setStatus('Selecione ao menos um PDF.', true, false);
      return;
    }
    setStatus('Nossa IA está analisando o(s) arquivo(s), aguarde…', false, true);
    btn.disabled = true;

    try {
      const fd = new FormData();
      // nome dos campos para múltiplos arquivos
      for (const f of files.files) {
        fd.append('pdfs[]', f, f.name);
      }
      fd.append('criterio_id', select.value);
      fd.append('contexto', contexto.value);

      const url = "{{ url_for('main.processar_analise_inatividade', numero=proc) }}";
      const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin'});
      const data = await resp.json();

      if (!resp.ok || !data.ok) {
        throw new Error(data.msg || 'Falha ao processar arquivos.');
      }

      out.value = data.texto || '';
      setStatus('Análise concluída.', false, false);
      btn2.disabled = false;
    } catch (e) {
      setStatus(e.message || 'Erro ao analisar PDFs.', true, false);
    } finally {
      btn.disabled = false;
      btn2.disabled = false;
    }
  });
})();
</script>

<script>
document.getElementById('btnAdicionar').addEventListener('click', async function(){
  try {
    const url = "{{ url_for('main.adicionar_no_relatorio', numero=proc) }}";
    //const quill = Quill.find(document.getElementById('txtResultado'));
    //const textoHtml = quill.root.innerHTML; // Pega o conteúdo como HTML
    const texto = document.getElementById('txtResultado').value;
    const fd = new FormData();
    fd.append('criterio_id', document.getElementById('selectCriterio').value);
    //fd.append('analiseInteligente', textoHtml);
    fd.append('analiseInteligente', texto);

    const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
    const data = await resp.json();
    if (data.ok && data.doc_html) {
      document.querySelector('.docx-page').innerHTML = data.doc_html;
    } else {
      alert(data.msg || "Erro ao atualizar o documento.");
    }
  } catch(e){
    alert("Erro ao adicionar no relatório: " + e.message);
  }
});
</script>

<script>
  document.getElementById('selectCriterio').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    document.getElementById('sugestaoDocumento').textContent = 
      "Sugestão de documento: " + (selected.dataset.sugestao || "");
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var btnBaixarPdf = document.getElementById('btnBaixarPdf');
  if (btnBaixarPdf) {
    btnBaixarPdf.addEventListener('click', function(e) {
      var overlay = document.getElementById('loading-overlay');
      if (overlay) {
        overlay.style.display = 'flex';
        overlay.querySelector('p').textContent = 'Aguarde o download do documento...';
      }
      // Oculta overlay após 5 segundos
      setTimeout(function() {
        if (overlay) overlay.style.display = 'none';
      }, 5000);
    });
  }
});
</script>
{% endblock %}

{% block content %}
<div class="row g-4 mt-4">
  <!-- Lado esquerdo: área de análise (você detalha depois) -->
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        
        <div class="mb-3">
          <label class="form-label fw-semibold" for="selectGrupo">
            Grupo de Análise:
          </label>
          <select id="selectGrupo" class="form-select">
            <option value="">Selecione um grupo...</option>
            {% for grupo in grupos %}
              <option value="{{ grupo.id }}">{{ grupo.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold" for="selectCriterio">
            Critério:
          </label>
          <select id="selectCriterio" class="form-select">
            <option value="">Selecione um grupo primeiro</option>
          </select>
          <div id="sugestaoDocumento" class="form-text mt-1">
            Sugestão de documento:
          </div>
        </div>

      <div id="blocoAnalise" aria-disabled="false">
        <div class="mb-3">
          <label class="form-label">Anexar PDF(s)</label>
          <input id="inputPDFs" class="form-control" type="file" accept="application/pdf" multiple>
          <div class="form-text">Você pode selecionar mais de um arquivo PDF.</div>
        </div>
        <div class="mb-3">
          <label for="inputContexto" class="form-label" style="color:royalblue;">Palavras de contexto:</label>
          <textarea id="inputContexto" class="form-control" rows="2"></textarea>
        </div>
        <div class="d-flex align-items-center gap-2 mb-3">
          <button id="btnAnalisar" class="btn btn-primary" type="button">
            Analisar
          </button>
          <button id="btnAdicionar" class="btn btn-warning me-2" type="button" disabled>
            Adicionar
          </button>
          <span id="analiseStatus" class="text-muted small"></span>
        </div>
        <a><img id="loadingGif" src="/static/ia2.gif" alt="Carregando..." style="float: right; z-index: 9999; width:67px; height:80px; display: none;"></a><br/>
        <label for="txtResultado" class="form-label" style="font-weight: bold;">Resultado da análise</label>
        <textarea id="txtResultado" class="form-control" rows="14" placeholder="O resultado da análise aparecerá aqui..."></textarea>
      </div>
    </div>
  </div>
</div>

  <!-- Lado direito: exibição do DOCX como página somente leitura -->
  <div class="col-lg-8 h-100" style="max-height: 1123px; overflow-y: auto;">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h6 class="mb-3">Documento (visualização somente leitura)

        <button type="button" id="btnShowText" class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#textContentModal">
          <i class="bi bi-body-text"></i> HTML
        </button>

        <a id="btnBaixarDocx" href="{{ url_for('main.baixar', numero=proc, tipo='word') }}" class="btn btn-outline-secondary btn-sm ms-2" download>
          <i class="bi bi-file-earmark-word"></i> Word
        </a>
        <a id="btnBaixarPdf" href="{{ url_for('main.baixar', numero=proc, tipo='pdf') }}" class="btn btn-outline-secondary btn-sm ms-2" download>
          <i class="bi bi-file-earmark-pdf"></i> PDF
        </a>
        <button id="btnSalvar" type="button" class="btn btn-outline-success btn-sm ms-2" data-url="{{ url_for('main.salvarAnalises', numero=proc) }}">
          <i class="bi bi-floppy"></i>  Salvar
        </button>
        <span id="salvarStatus"></span>
      </h6>
        <div id="editor" class="docx-page mx-auto" style="font-weight: normal;">
          {{ doc_html|safe }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ESTRUTURA DO POPUP (MODAL) -->
<div class="modal fade" id="textContentModal" tabindex="-1" aria-labelledby="textModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="textModalLabel">Código HTML do Relatório</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small">Pode copiar o texto abaixo (Ctrl+A, Ctrl+C).</p>
        <textarea id="modalTextView" class="form-control" readonly rows="20"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* simula uma página A4 com fundo branco */
  .docx-page {
    background: #fff;
    color: #000;
    width: 794px;           /* ~A4 em px a ~96dpi */
    max-width: 100%;
    /*min-height: 1123px;     /* altura aproximada A4 */
    padding: 32px;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
    box-shadow: 0 1rem 1.5rem rgba(0,0,0,0.08);
    overflow: auto;
  }
  .docx-page * {
    background: transparent !important;
  }
</style>
<!-- Overlay de carregamento -->
<div id="loading-overlay" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
  z-index: 9999;">
  <div style="
    background: white;
    padding: 2em;
    border-radius: 8px;
    text-align: center;
    font-size: 1rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);">
    <p>Aguarde o download do documento...</p>
  </div>
</div>
{% endblock %}
