{% extends 'base.html' %}
{% block title %}Análise de inatividade – Processo {{ proc }}{% endblock %}

{% block extra_js %}

<script>
(function(){
  const select = document.getElementById('selectAnalise');
  const bloco = document.getElementById('blocoAnalise');
  const files = document.getElementById('inputPDFs');
  const btn   = document.getElementById('btnAnalisar');
  const btn2   = document.getElementById('btnAdicionar');
  const out   = document.getElementById('txtResultado');
  const stat  = document.getElementById('analiseStatus');

  function setStatus(msg, isError=false) {
    stat.textContent = msg || '';
    stat.className = 'small ' + (isError ? 'text-danger' : 'text-muted');
  }

  btn.addEventListener('click', async function(){
    if (!files.files || files.files.length === 0) {
      setStatus('Selecione ao menos um PDF.', true);
      return;
    }
    setStatus('Nossa IA está analisando o(s) arquivo(s), aguarde…');
    btn.disabled = true;

    try {
      const fd = new FormData();
      // nome dos campos para múltiplos arquivos
      for (const f of files.files) {
        fd.append('pdfs[]', f, f.name);
      }
      fd.append('analise_id', select.value);

      const url = "{{ url_for('main.processar_analise_inatividade', numero=proc) }}";
      const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin'});
      const data = await resp.json();

      if (!resp.ok || !data.ok) {
        throw new Error(data.msg || 'Falha ao processar arquivos.');
      }

      out.value = data.texto || '';
      setStatus('Análise concluída.');
      btn2.disabled = false;
    } catch (e) {
      setStatus(e.message || 'Erro ao analisar PDFs.', true);
    } finally {
      btn.disabled = false;
      btn2.disabled = false;
    }
  });
})();
</script>

<script>
document.getElementById('btnAdicionar').addEventListener('click', async function(){
  try {
    const url = "{{ url_for('main.adicionar_no_relatorio') }}";
    const texto = document.getElementById('txtResultado').value;
    const fd = new FormData();
    fd.append('analise_id', document.getElementById('selectAnalise').value);
    fd.append('analiseInteligente', texto);

    const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
    const data = await resp.json();
    if (data.ok && data.doc_html) {
      document.querySelector('.docx-page').innerHTML = data.doc_html;
    } else {
      alert(data.msg || "Erro ao atualizar o documento.");
    }
  } catch(e){
    alert("Erro ao adicionar no relatório: " + e.message);
  }
});
</script>

<script>
  document.getElementById('selectAnalise').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    document.getElementById('sugestaoDocumento').textContent = 
      "Sugestão de documento: " + (selected.dataset.sugestao || "");
  });
</script>
{% endblock %}

{% block content %}

<div class="row g-4 mt-4">
  <!-- Lado esquerdo: área de análise (você detalha depois) -->
  <div class="col-lg-4">
  <div class="card shadow-sm h-100">
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label fw-semibold" for="selectAnalise">
          Selecione um critério de análise:
        </label>
        <select id="selectAnalise" class="form-select">
          {% for analise in analises %}
            <option value="{{ analise.id }}" data-sugestao="{{ analise.sugestao_documento }}">{{ analise.nome }}</option>
          {% endfor %}
        </select>
        <div id="sugestaoDocumento" class="form-text mt-1">
          Sugestão de documento: {{ analises[0].sugestao_documento if analises else '' }}
        </div>
      </div>

      <div id="blocoAnalise" aria-disabled="false">
        <div class="mb-3">
          <label class="form-label">Anexar PDF(s)</label>
          <input id="inputPDFs" class="form-control" type="file" accept="application/pdf" multiple>
          <div class="form-text">Você pode selecionar mais de um arquivo PDF.</div>
        </div>

        <div class="d-flex align-items-center gap-2 mb-3">
          <button id="btnAnalisar" class="btn btn-primary" type="button">
            Analisar
          </button>
          <button id="btnAdicionar" class="btn btn-warning me-2" type="button" disabled>
            Adicionar
          </button>
          <span id="analiseStatus" class="text-muted small"></span>
        </div>

        <label for="txtResultado" class="form-label">Resultado da análise</label>
        <textarea id="txtResultado" class="form-control" rows="14" placeholder="O resultado da análise aparecerá aqui..."></textarea>
      </div>
    </div>
  </div>
</div>

  <!-- Lado direito: exibição do DOCX como página somente leitura -->
  <div class="col-lg-8" style="max-height: 80vh; overflow-y: auto;">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h6 class="mb-3">Documento (visualização somente leitura)
        <a id="btnBaixarDocx" href="{{ url_for('main.baixar_docx', numero=proc) }}" class="btn btn-outline-secondary btn-sm ms-2" download>
          Baixar
        </a></h6>
        <div id="editor" class="docx-page mx-auto">
          {{ doc_html|safe }}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* simula uma página A4 com fundo branco */
  .docx-page {
    background: #fff;
    color: #000;
    width: 794px;           /* ~A4 em px a ~96dpi */
    max-width: 100%;
    min-height: 1123px;     /* altura aproximada A4 */
    padding: 32px;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
    box-shadow: 0 1rem 1.5rem rgba(0,0,0,0.08);
    overflow: auto;
  }
  .docx-page * {
    background: transparent !important;
  }
</style>
{% endblock %}
