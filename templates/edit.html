{% extends 'base.html' %}
{% block title %}{{ 'Cadastrar novo processo' if not proc else ('Editar Processo nº ' ~ proc.processo) }}{% endblock %}

{% block extra_js %}
<script>
(function () {
  const btn = document.getElementById('btnAcreprev');
  const statusEl = document.getElementById('acreprev-status');

  function setStatus(msg, tipo = 'info') {
    if (!statusEl) return;
    statusEl.textContent = msg || '';

    // Define a classe de cor com base no tipo
    let corClasse = 'text-muted'; // padrão

    switch (tipo) {
      case 'erro':
        corClasse = 'text-danger';
        break;
      case 'sucesso':
        corClasse = 'text-success';
        break;
      case 'aviso':
        corClasse = 'text-warning';
        break;
      case 'info':
      default:
        corClasse = 'text-muted';
    }

    statusEl.className = 'form-text ' + corClasse;
  }

  function setVal(id, val) {
    const el = document.getElementById(id);
    if (el) el.value = (val ?? '');
  }

  function normalizarCpf(cpf) {
    return (cpf || '').replace(/\D/g, '');
  }

  btn?.addEventListener('click', async function () {
    const cpfInput = document.getElementById('cpf');
    const cpf = normalizarCpf(cpfInput?.value || '');
    if (!cpf || cpf.length !== 11) {
      setStatus('Informe um CPF válido (11 dígitos).', 'erro');
      return;
    }

    setStatus('Nossa IA está tabalhando nos dados do Acreprevidência...', 'aviso');
    btn.disabled = true;

    try {
      const url = `{{ url_for('main.api_acreprev') }}?cpf=${cpf}`;
      const resp = await fetch(url, { method: 'GET' });
      const payload = await resp.json();

      if (!resp.ok || !payload.ok) {
        throw new Error(payload.msg || 'Falha ao consultar a API.');
      }

      const d = payload.data || {};

      // preenche os campos do formulário
            
      const campos = {
          '{{ form.servidor.id }}': d.servidor,
          '{{ form.matricula.id }}': d.matricula,
          '{{ form.cargo.id }}': d.cargo,
          '{{ form.orgao.id }}': d.orgao,
          '{{ form.proventos.id }}': d.proventos,
          '{{ form.data_publicacao.id }}': d.data_concessao,
          '{{ form.fundamento_legal.id }}': d.fundamento_legal,
          '{{ form.anos_tempo_de_contribuicao.id }}': d.tempo_anos,
          '{{ form.dias_tempo_de_contribuicao.id }}': d.tempo_dias
        };

        // Preenche apenas os campos que estão vazios
        for (const [id, valor] of Object.entries(campos)) {
          const el = document.getElementById(id);
          if (el && !el.value) {
            setVal(id, valor);
          }
        }

        setStatus('Dados importados com sucesso.', 'sucesso');

    } catch (err) {
      setStatus(err.message || 'Erro ao consultar a API.', 'erro');
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>

<script>
// Confirmação após salvar e geração de download sem redirecionar
document.addEventListener('DOMContentLoaded', function() {
  var success = document.querySelector('.alert-success');
  if (success && confirm('Registro atualizado com sucesso!\nDeseja gerar a certidão agora?')) {
    var overlay = document.getElementById('loading-overlay');
    if (overlay) overlay.style.display = 'flex';

    // Cria link para disparar download sem troca de página
    var url = "{{ url_for('main.gerar_certidao', numero=proc.processo) }}";
    var a = document.createElement('a');
    a.href = url;
    a.download = '';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // Oculta overlay após 5 segundos
    setTimeout(function() {
      if (overlay) overlay.style.display = 'none';
    }, 5000);
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var cpfField = document.getElementById('cpf');
  if (!cpfField) return;

  cpfField.addEventListener('input', function(e) {
    // só dígitos, máximo 11
    var v = e.target.value.replace(/\D/g, '').slice(0,11);

    // aplica as partes da máscara conforme o tamanho
    if (v.length <= 3) {
      e.target.value = v;
    } else if (v.length <= 6) {
      e.target.value = v.replace(/(\d{3})(\d+)/, '$1.$2');
    } else if (v.length <= 9) {
      e.target.value = v.replace(/(\d{3})(\d{3})(\d+)/, '$1.$2.$3');
    } else {
      e.target.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
    }
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Lógica para overlay ao clicar em "Gerar Certidão"
  var btnCertidao = document.getElementById('btnCertidao');
  if (btnCertidao) {
    btnCertidao.addEventListener('click', function(e) {
      var overlay = document.getElementById('loading-overlay');
      if (overlay) {
        overlay.style.display = 'flex';
        overlay.querySelector('p').textContent = 'Aguarde o download do documento...';
      }
      // Oculta overlay após 5 segundos
      setTimeout(function() {
        if (overlay) overlay.style.display = 'none';
      }, 5000);
    });
  }
});
</script>
{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
  <div class="col-md-10">
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="card-title text-center text-primary mb-4">
          {{ 'Cadastrar novo processo' if not proc else ('Editar Processo nº ' ~ proc.processo) }}
        </h4>
        <form method="post">
          {{ form.hidden_tag() }}
          {% if not proc and form.processo %}
          <div class="mb-3">
            {{ form.processo.label(class="form-label") }}
            {{ form.processo(class="form-control", placeholder="999999", maxlength="6", pattern="\d{6}") }}
            <div class="form-text">Use 6 dígitos (ex.: 123456). </div>
          </div>
          {% endif %}
          <!-- Campos... -->
          {% for field in [
              form.autuacao_processo, form.classe, form.servidor, form.matricula, 
              form.cpf, form.cargo, form.orgao,
              form.orgao_previdencia, form.proventos, form.folha_ato_fixacao,
              form.ato_concessorio, form.data_ato_concessorio, form.folha_ato_concessorio,
              form.data_inicio_concessao,
              form.publicacao, form.data_publicacao, form.fundamento_legal,
            ] %}
            <div class="mb-3">
            {% if field.name == 'cpf' %}
              <label class="form-label">{{ field.label.text }}</label>
              <div class="input-group">
                {{ field(class="form-control", id="cpf", placeholder="000.000.000-00") }}
                <button class="btn btn-outline-primary" type="button" id="btnAcreprev"
                        title="Procurar informações">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div id="acreprev-status" class="form-text"></div>
            {% else %}
              {{ field.label(class="form-label") }}
              {{ field(class="form-control", id=field.id) }}
            {% endif %}
          </div>
          {% endfor %}
          <div class="mb-3">
            <label class="form-label">Tempo de contribuição</label>
            <div class="d-flex gap-2">
              {{ form.anos_tempo_de_contribuicao(class="form-control w-auto") }} anos
              {{ form.dias_tempo_de_contribuicao(class="form-control w-auto") }} dias
            </div>
          </div>
          <div class="text-center">
            <button type="submit" class="btn btn-success">Salvar</button>
          </div>
        </form>
        {% if proc %}
        <div class="text-center mt-4">
          <a id="btnCertidao" href="{{ url_for('main.gerar_certidao', numero=proc.processo) }}" class="btn btn-danger me-2">Gerar Certidão</a>
          <a href="{{ url_for('main.analise_inatividade', numero=proc.processo) }}" class="btn btn-warning me-2">Analisar</a>
          <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Nova busca</a>
        </div>
        {% endif %}
        </div>
    </div>
  </div>
</div>

<!-- Overlay de carregamento -->
<div id="loading-overlay" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
  z-index: 9999;">
  <div style="
    background: white;
    padding: 2em;
    border-radius: 8px;
    text-align: center;
    font-size: 1rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);">
    <p>Aguarde o download do documento...</p>
  </div>
</div>
{% endblock %}